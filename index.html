<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ValenTango 2026 Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png" />
</head>
<body class="transition-colors">

    <header class="main-header sticky top-0 z-40">
        <div class="max-w-2xl mx-auto px-6 pb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight">ValenTango 2026</h1>
                    <p class="text-xs uppercase tracking-widest font-bold mt-1" style="color: var(--text-secondary)">Portland</p>
                </div>
                <button onclick="toggleTheme()" class="theme-toggle" id="theme-btn">Light Mode</button>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 mb-3">
                <button onclick="setFilter('all')" id="filter-all" class="filter-chip active">All</button>
                <button onclick="setFilter('fav')" id="filter-fav" class="filter-chip fav-active">★</button>
                <button onclick="setFilter('milonga')" id="filter-milonga" class="filter-chip">Milongas</button>
                <button onclick="setFilter('beg')" id="filter-beg" class="filter-chip">Beg</button>
                <button onclick="setFilter('int')" id="filter-int" class="filter-chip">Int</button>
                <button onclick="setFilter('adv')" id="filter-adv" class="filter-chip">Adv</button>
                <button onclick="setFilter('advCouples')" id="filter-advCouples" class="filter-chip">Adv Couples</button>
                <button onclick="setFilter('tuesday')" id="filter-tuesday" class="filter-chip !text-[10px] uppercase">Tue</button>
                <button onclick="setFilter('wednesday')" id="filter-wednesday" class="filter-chip !text-[10px] uppercase">Wed</button>
                <button onclick="setFilter('thursday')" id="filter-thursday" class="filter-chip !text-[10px] uppercase">Thu</button>
                <button onclick="setFilter('friday')" id="filter-friday" class="filter-chip !text-[10px] uppercase">Fri</button>
                <button onclick="setFilter('saturday')" id="filter-saturday" class="filter-chip !text-[10px] uppercase">Sat</button>
                <button onclick="setFilter('sunday')" id="filter-sunday" class="filter-chip !text-[10px] uppercase">Sun</button>
                <button onclick="setFilter('monday')" id="filter-monday" class="filter-chip !text-[10px] uppercase">Mon</button>
                
                <button onclick="clearFilters()" id="clear-filters" class="text-[11px] font-black uppercase tracking-widest px-2 text-rose-500 hidden whitespace-nowrap bg-transparent border-none cursor-pointer">
                    Clear ×
                </button>
            </div>

            <div class="relative flex items-center">
                <input 
                    type="text" 
                    id="search-input" 
                    oninput="renderEvents()" 
                    placeholder="Search by topic, instructor, or description..." 
                    class="w-full bg-[var(--chip-bg)] border border-[var(--chip-border)] text-[var(--text-primary)] pl-4 pr-12 py-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-blue)] transition-all"
                />
                <button 
                    onclick="clearSearch()" 
                    id="clear-search-btn"
                    class="absolute right-3 p-2 text-[var(--text-secondary)] hover:text-rose-500 transition-colors hidden"
                    title="Clear search"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main id="event-list" class="max-w-2xl mx-auto px-6 pt-4"></main>

    <script src="events.js"></script>
    <script src="names.js"></script>

    <script>
        const FILTER_KEY = 'valentango_filter_pref';
        const THEME_KEY = 'valentango_theme_pref';
        const FAV_KEY = 'valentango_favorites';
        const DAYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        let currentFilters = ['all'];
        let favorites = [];

        function initSettings() {
            try {
                const savedFilters = localStorage.getItem(FILTER_KEY);
                if (savedFilters) {
                    currentFilters = JSON.parse(savedFilters);
                }

                const savedFavs = localStorage.getItem(FAV_KEY);
                if (savedFavs) {
                    favorites = JSON.parse(savedFavs);
                }

                const isLight = localStorage.getItem(THEME_KEY) === 'true';
                if (isLight) {
                    document.body.classList.add('light-mode');
                    updateThemeButton(true);
                }
            } catch (e) { console.warn("Storage access denied", e); }
        }

        function toggleFavorite(id) {
            const index = favorites.indexOf(id);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(id);
            }
            try {
                localStorage.setItem(FAV_KEY, JSON.stringify(favorites));
            } catch (e) {}
            renderEvents();
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            updateThemeButton(isLight);
            try {
                localStorage.setItem(THEME_KEY, isLight);
            } catch (e) { console.warn("Could not save theme", e); }
        }

        function updateThemeButton(isLight) {
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerText = isLight ? "Dark Mode" : "Light Mode";
        }

        function formatTime(iso) { return new Date(iso).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); }
        function formatDate(iso) { return new Date(iso).toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' }); }

        function setFilter(filter) {
            if (filter === 'all') {
                currentFilters = ['all'];
            } else {
                currentFilters = currentFilters.filter(f => f !== 'all');

                if (currentFilters.includes(filter)) {
                    currentFilters = currentFilters.filter(f => f !== filter);
                } else {
                    currentFilters.push(filter);
                }

                if (currentFilters.length === 0) currentFilters = ['all'];
            }

            try { 
                localStorage.setItem(FILTER_KEY, JSON.stringify(currentFilters)); 
            } catch (e) {}
            
            updateFilterUI();
            renderEvents();
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            renderEvents();
            input.focus();
        }

        function clearFilters() {
            // Decoupled: Clearing category chips no longer resets search box text
            setFilter('all');
        }

        function updateFilterUI() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                const filterId = chip.id.replace('filter-', '');
                if (currentFilters.includes(filterId)) {
                    chip.classList.add('active');
                } else {
                    chip.classList.remove('active');
                }
            });

            const clearFiltersBtn = document.getElementById('clear-filters');
            // Logic Clean-up: Clear button only appears if category filters (not search) are active
            if (currentFilters.length === 1 && currentFilters.includes('all')) {
                clearFiltersBtn.classList.add('hidden');
            } else {
                clearFiltersBtn.classList.remove('hidden');
            }
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            if (clearSearchBtn) {
                searchTerm.length > 0 ? clearSearchBtn.classList.remove('hidden') : clearSearchBtn.classList.add('hidden');
            }

            if (!list || typeof events === 'undefined') return;

            list.innerHTML = '';
            
            const linkifyInstructor = (instructorStr, eventType) => {
                if (!instructorStr || typeof nameToUrl === 'undefined') return instructorStr;
                if (nameToUrl[instructorStr]) {
                    return `<a href="${nameToUrl[instructorStr]}" target="_blank" class="hover:underline">${instructorStr}</a>`;
                }
                if (instructorStr.toUpperCase().includes("DJ")) {
                    let djHandled = instructorStr;
                    Object.keys(nameToUrl).forEach(name => {
                        if (instructorStr.includes(name)) {
                            const link = `<a href="${nameToUrl[name]}" target="_blank" class="hover:underline">${name}</a>`;
                            djHandled = djHandled.replace(name, link);
                        }
                    });
                    return djHandled;
                }
                if (eventType === 'milonga') {
                    let finalStr = instructorStr;
                    const sortedNames = Object.keys(nameToUrl).sort((a, b) => b.length - a.length);
                    sortedNames.forEach(name => {
                        if (finalStr.includes(name) && !finalStr.includes(`>${name}</a>`)) {
                            const link = `<a href="${nameToUrl[name]}" target="_blank" class="hover:underline">${name}</a>`;
                            finalStr = finalStr.replace(name, link);
                        }
                    });
                    return finalStr;
                }
                return instructorStr;
            };

            const filtered = events.filter(e => {
                // 1. Favorites check
                if (currentFilters.includes('fav') && !favorites.includes(e.id)) {
                    return false;
                }

                // 2. Search check
                const matchesSearch = !searchTerm || 
                    e.title.toLowerCase().includes(searchTerm) || 
                    (e.instructor || "").toLowerCase().includes(searchTerm) || 
                    (e.description || "").toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;

                // 3. Day and Category logic
                if (currentFilters.includes('all')) return true;

                const activeFilters = currentFilters.filter(f => f !== 'fav');
                if (activeFilters.length === 0) return true;

                const selectedDays = activeFilters.filter(f => DAYS.includes(f));
                const selectedCats = activeFilters.filter(f => !DAYS.includes(f));

                // If days are selected, event must match one of them
                if (selectedDays.length > 0) {
                    const eventDay = new Date(e.start).toLocaleDateString([], { weekday: 'long' }).toLowerCase();
                    if (!selectedDays.includes(eventDay)) return false;
                }

                // If categories are selected, event must match one of them
                if (selectedCats.length > 0) {
                    const matchesCat = selectedCats.some(f => {
                        if (f === 'milonga') return e.type === 'milonga';
                        return (e.level || "").toLowerCase() === f.toLowerCase();
                    });
                    if (!matchesCat) return false;
                }

                return true;

            }).sort((a,b) => new Date(a.start) - new Date(b.start));

            updateFilterUI();

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-[var(--text-secondary)]">No events match your criteria.</div>`;
                return;
            }

            let lastDate = '';
            filtered.forEach(e => {
                const dateStr = formatDate(e.start);
                const isFav = favorites.includes(e.id);
                
                if(dateStr !== lastDate) {
                    const h = document.createElement('div');
                    h.className = 'date-divider';
                    h.innerText = dateStr;
                    list.appendChild(h);
                    lastDate = dateStr;
                }

                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-black tracking-tighter ${e.type === 'milonga' ? 'milonga-indicator' : 'class-indicator'}">${formatTime(e.start)} - ${formatTime(e.end)}</span>
                            <span class="room-pill">${e.room}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="price-text">${e.price}</span>
                            <div onclick="toggleFavorite(${e.id})" class="fav-star text-lg ${isFav ? 'text-amber-400' : 'text-zinc-600 opacity-30'} cursor-pointer">
                                ★
                            </div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold leading-tight mb-2" style="color: var(--text-primary)">${e.title}</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-[11px] font-bold uppercase tracking-wider" style="color: var(--text-secondary)">${e.level === 'advCouples' ? 'ADV COUPLES' : e.level}</span>
                        <span style="color: var(--border-color)">•</span>
                        <span class="text-[11px] font-bold uppercase tracking-wider instructor-link" style="color: var(--accent-purple)">${linkifyInstructor(e.instructor, e.type)}</span>
                    </div>
                    <p class="text-[14px] leading-relaxed font-normal" style="color: var(--text-secondary)">${e.description}</p>
                `;
                list.appendChild(card);
            });
        }

        window.addEventListener('load', () => {
            initSettings();
            updateFilterUI();
            renderEvents();
        });
    </script>

    <footer class="fixed bottom-0 left-0 right-0 z-50 px-6 pb-8 pt-4 pointer-events-none">
        <div class="max-w-2xl mx-auto flex justify-center gap-4 pointer-events-auto">
            <a href="how.html" class="footer-link">
                <span>?</span>
            </a>
            <a href="https://valentango.us/parking/" target="_blank" class="footer-link">
                <span>Parking</span>
            </a>
            <a href="map.html" class="footer-link">
                <span>Venue Map</span>
            </a>
        </div>
    </footer>
</body>
</html>