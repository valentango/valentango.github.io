<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ValenTango 2026 Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png" />
</head>
<body class="transition-colors">

    <header class="main-header sticky top-0 z-40">
        <div class="max-w-2xl mx-auto px-4 pb-4">
            <div class="flex justify-between items-center mb-4 pt-2">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">ValenTango 2026</h1>
                    <p class="text-[10px] uppercase tracking-widest font-bold" style="color: var(--text-secondary)">Portland, OR</p>
                </div>
                <button onclick="toggleTheme()" class="theme-toggle" id="theme-btn">Light Mode</button>
            </div>
            
            <div class="flex flex-wrap items-center gap-2 mb-3">
                <button onclick="setFilter('all')" id="filter-all" class="filter-chip active">All</button>
                <button onclick="setFilter('fav')" id="filter-fav" class="filter-chip fav-active">★</button>
                <button onclick="setFilter('milonga')" id="filter-milonga" class="filter-chip">Milongas</button>
                <span class="text-[10px] opacity-30">|</span>
                <button onclick="setFilter('beg')" id="filter-beg" class="filter-chip">Beg</button>
                <button onclick="setFilter('int')" id="filter-int" class="filter-chip">Int</button>
                <button onclick="setFilter('adv')" id="filter-adv" class="filter-chip">Adv</button>
                <button onclick="setFilter('advCouples')" id="filter-advCouples" class="filter-chip">Adv Couples</button>
                <span class="text-[10px] opacity-30">|</span>
                <button onclick="setFilter('tuesday')" id="filter-tuesday" class="filter-chip ">Tue</button>
                <button onclick="setFilter('wednesday')" id="filter-wednesday" class="filter-chip ">Wed</button>
                <button onclick="setFilter('thursday')" id="filter-thursday" class="filter-chip ">Thu</button>
                <button onclick="setFilter('friday')" id="filter-friday" class="filter-chip ">Fri</button>
                <button onclick="setFilter('saturday')" id="filter-saturday" class="filter-chip ">Sat</button>
                <button onclick="setFilter('sunday')" id="filter-sunday" class="filter-chip ">Sun</button>
                <button onclick="setFilter('monday')" id="filter-monday" class="filter-chip ">Mon</button>
                
                <button onclick="clearFilters()" id="clear-filters" class="text-[10px] font-black uppercase tracking-widest px-2 text-rose-500 hidden whitespace-nowrap bg-transparent border-none cursor-pointer">
                    Clear ×
                </button>
            </div>

            <div class="relative flex items-center">
                <input 
                    type="text" 
                    id="search-input" 
                    oninput="renderEvents()" 
                    placeholder="Search by topic, instructor..." 
                    class="w-full bg-[var(--chip-bg)] border border-[var(--chip-border)] text-[var(--text-primary)] pl-4 pr-10 py-2.5 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-blue)] transition-all"
                />
                <button 
                    onclick="clearSearch()" 
                    id="clear-search-btn"
                    class="absolute right-2 p-2 text-[var(--text-secondary)] hover:text-rose-500 transition-colors hidden"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main id="event-list" class="max-w-2xl mx-auto px-4 pt-2"></main>

    <script src="events.js"></script>
    <script src="names.js"></script>

    <script>
        const FILTER_KEY = 'valentango_filter_pref';
        const THEME_KEY = 'valentango_theme_pref';
        const FAV_KEY = 'valentango_favorites';
        const DAYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        let currentFilters = ['all'];
        let favorites = [];

        function initSettings() {
            try {
                const savedFilters = localStorage.getItem(FILTER_KEY);
                if (savedFilters) currentFilters = JSON.parse(savedFilters);
                const savedFavs = localStorage.getItem(FAV_KEY);
                if (savedFavs) favorites = JSON.parse(savedFavs);
                const isLight = localStorage.getItem(THEME_KEY) === 'true';
                if (isLight) {
                    document.body.classList.add('light-mode');
                    updateThemeButton(true);
                }
            } catch (e) { console.warn("Storage access denied", e); }
        }

        function toggleFavorite(id) {
            const index = favorites.indexOf(id);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(id);
            try { localStorage.setItem(FAV_KEY, JSON.stringify(favorites)); } catch (e) {}
            renderEvents();
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            updateThemeButton(isLight);
            try { localStorage.setItem(THEME_KEY, isLight); } catch (e) {}
        }

        function updateThemeButton(isLight) {
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerText = isLight ? "Dark Mode" : "Light Mode";
        }

        function formatTime(iso) { 
            return new Date(iso).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).replace(' ', ''); 
        }
        function formatDate(iso) { return new Date(iso).toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' }); }

        function setFilter(filter) {
            if (filter === 'all') {
                currentFilters = ['all'];
            } else {
                currentFilters = currentFilters.filter(f => f !== 'all');
                if (currentFilters.includes(filter)) currentFilters = currentFilters.filter(f => f !== filter);
                else currentFilters.push(filter);
                if (currentFilters.length === 0) currentFilters = ['all'];
            }
            try { localStorage.setItem(FILTER_KEY, JSON.stringify(currentFilters)); } catch (e) {}
            updateFilterUI();
            renderEvents();
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            renderEvents();
            input.focus();
        }

        function clearFilters() { setFilter('all'); }

        function updateFilterUI() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                const filterId = chip.id.replace('filter-', '');
                if (currentFilters.includes(filterId)) chip.classList.add('active');
                else chip.classList.remove('active');
            });
            const clearFiltersBtn = document.getElementById('clear-filters');
            if (currentFilters.length === 1 && currentFilters.includes('all')) clearFiltersBtn.classList.add('hidden');
            else clearFiltersBtn.classList.remove('hidden');
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            if (clearSearchBtn) searchTerm.length > 0 ? clearSearchBtn.classList.remove('hidden') : clearSearchBtn.classList.add('hidden');
            if (!list || typeof events === 'undefined') return;

            list.innerHTML = '';
            
            const linkifyInstructor = (instructorStr, eventType) => {
                if (!instructorStr || typeof nameToUrl === 'undefined') return instructorStr;
                if (nameToUrl[instructorStr]) return `<a href="${nameToUrl[instructorStr]}" target="_blank">${instructorStr}</a>`;
                
                let finalStr = instructorStr;
                const sortedNames = Object.keys(nameToUrl).sort((a, b) => b.length - a.length);
                sortedNames.forEach(name => {
                    if (finalStr.includes(name) && !finalStr.includes(`>${name}</a>`)) {
                        finalStr = finalStr.replace(name, `<a href="${nameToUrl[name]}" target="_blank">${name}</a>`);
                    }
                });
                return finalStr;
            };

            const filtered = events.filter(e => {
                if (currentFilters.includes('fav') && !favorites.includes(e.id)) return false;
                const matchesSearch = !searchTerm || e.title.toLowerCase().includes(searchTerm) || 
                    (e.instructor || "").toLowerCase().includes(searchTerm) || (e.description || "").toLowerCase().includes(searchTerm);
                if (!matchesSearch) return false;
                if (currentFilters.includes('all')) return true;
                const activeFilters = currentFilters.filter(f => f !== 'fav');
                if (activeFilters.length === 0) return true;
                const selectedDays = activeFilters.filter(f => DAYS.includes(f));
                const selectedCats = activeFilters.filter(f => !DAYS.includes(f));
                if (selectedDays.length > 0) {
                    const eventDay = new Date(e.start).toLocaleDateString([], { weekday: 'long' }).toLowerCase();
                    if (!selectedDays.includes(eventDay)) return false;
                }
                if (selectedCats.length > 0) {
                    const matchesCat = selectedCats.some(f => {
                        if (f === 'milonga') return e.type === 'milonga';
                        return (e.level || "").toLowerCase() === f.toLowerCase();
                    });
                    if (!matchesCat) return false;
                }
                return true;
            }).sort((a,b) => new Date(a.start) - new Date(b.start));

            updateFilterUI();

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-[var(--text-secondary)] opacity-50">No matches found.</div>`;
                return;
            }

            let lastDate = '';
            filtered.forEach(e => {
                const dateStr = formatDate(e.start);
                const isFav = favorites.includes(e.id);
                
                if(dateStr !== lastDate) {
                    const h = document.createElement('div');
                    h.className = 'date-divider';
                    h.innerText = dateStr;
                    list.appendChild(h);
                    lastDate = dateStr;
                }

                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex flex-col gap-1">
                            <span class="text-[11px] font-black tracking-tight ${e.type === 'milonga' ? 'milonga-indicator' : 'class-indicator'}">${formatTime(e.start)}—${formatTime(e.end)}</span>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div onclick="toggleFavorite(${e.id})" class="fav-star ${isFav ? 'text-amber-400' : 'text-zinc-600 opacity-30'}">★</div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-x-2 gap-y-1 mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-wider opacity-70" style="color: var(--text-secondary)">${e.level === 'advCouples' ? 'ADV COUPLES' : e.level}</span>
                        <span class="text-[10px] opacity-30">|</span>
                        <span class="room-pill">${e.room}</span>
                        <span class="text-[10px] opacity-30">|</span>
                        <span class="price-text">${e.price}</span>
                        <span class="text-[10px] opacity-30">|</span>
                        <span class="text-[10px] font-bold uppercase tracking-wider instructor-link" style="color: var(--accent-purple)">${linkifyInstructor(e.instructor, e.type)}</span>
                    </div>
                                        <h3 class="text-lg sm:text-xl font-bold leading-tight mb-1" style="color: var(--text-primary)">${e.title}</h3>
                    <p class="text-[13px] leading-snug font-normal opacity-90" style="color: var(--text-secondary)">${e.description}</p>
                `;
                list.appendChild(card);
            });
        }

        window.addEventListener('load', () => {
            initSettings();
            updateFilterUI();
            renderEvents();
        });
    </script>

    <footer class="fixed bottom-0 left-0 right-0 z-50 px-4 pb-6 pt-2 pointer-events-none">
        <div class="max-w-2xl mx-auto flex justify-center gap-3 pointer-events-auto">
            <a href="how.html" class="footer-link"><span>?</span></a>
            <a href="https://valentango.us/parking/" target="_blank" class="footer-link"><span>Parking</span></a>
            <a href="map.html" class="footer-link"><span>Venue Map</span></a>
        </div>
    </footer>
</body>
</html>