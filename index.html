<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ValenTango 2026 Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
</head>
<body class="transition-colors">

    <header class="main-header sticky top-0 z-40">
        <div class="max-w-2xl mx-auto px-4">
            <div class="flex justify-between items-center mb-3 pt-1">
                <div>
                    <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">ValenTango 2026</h1>
                </div>
                <button onclick="toggleTheme()" class="theme-toggle" id="theme-btn">Light Mode</button>
            </div>
            
            <div id="filter-wrapper" class="filter-container mb-3">
                <div class="space-y-4 mb-4">
                    <div>
                        <p class="text-[9px] font-black uppercase tracking-widest mb-1.5 opacity-50">General</p>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="setFilter('all')" id="filter-all" class="filter-chip active">All</button>
                            <button onclick="setFilter('fav')" id="filter-fav" class="filter-chip fav-active">★ Favorites</button>
                            <button onclick="setFilter('milonga')" id="filter-milonga" class="filter-chip">Milongas</button>
                            <button onclick="clearFilters()" id="clear-filters" class="text-[10px] font-black uppercase tracking-widest px-2 text-rose-500 hidden bg-transparent border-none cursor-pointer">
                                Clear ×
                            </button>
                        </div>
                    </div>

                    <div>
                        <p class="text-[9px] font-black uppercase tracking-widest mb-1.5 opacity-50">Class Levels</p>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="setFilter('beg')" id="filter-beg" class="filter-chip">Beg</button>
                            <button onclick="setFilter('int')" id="filter-int" class="filter-chip">Int</button>
                            <button onclick="setFilter('adv')" id="filter-adv" class="filter-chip">Adv</button>
                            <button onclick="setFilter('advCouples')" id="filter-advCouples" class="filter-chip">Adv Couples</button>
                        </div>
                    </div>

                    <div>
                        <p class="text-[9px] font-black uppercase tracking-widest mb-1.5 opacity-50">Instructors</p>
                        <div id="instructor-filters" class="flex flex-wrap items-center gap-2">
                            </div>
                    </div>

                    <div>
                        <p class="text-[9px] font-black uppercase tracking-widest mb-1.5 opacity-50">Days</p>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="setFilter('tuesday')" id="filter-tuesday" class="filter-chip">Tue</button>
                            <button onclick="setFilter('wednesday')" id="filter-wednesday" class="filter-chip">Wed</button>
                            <button onclick="setFilter('thursday')" id="filter-thursday" class="filter-chip">Thu</button>
                            <button onclick="setFilter('friday')" id="filter-friday" class="filter-chip">Fri</button>
                            <button onclick="setFilter('saturday')" id="filter-saturday" class="filter-chip">Sat</button>
                            <button onclick="setFilter('sunday')" id="filter-sunday" class="filter-chip">Sun</button>
                            <button onclick="setFilter('monday')" id="filter-monday" class="filter-chip">Mon</button>
                        </div>
                    </div>

                    <div>
                        <p class="text-[9px] font-black uppercase tracking-widest mb-1.5 opacity-50">Keywords</p>
                        <div class="relative flex items-center">
                            <input 
                                type="text" 
                                id="search-input" 
                                oninput="renderEvents()" 
                                placeholder="Search topic or instructor..." 
                                class="w-full bg-[var(--chip-bg)] border border-[var(--chip-border)] text-[var(--text-primary)] pl-4 pr-10 py-2 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent-blue)] transition-all"
                            />
                            <button onclick="clearSearch()" id="clear-search-btn" class="absolute right-2 p-2 text-[var(--text-secondary)] hover:text-rose-500 transition-colors hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="date-row flex justify-between items-center py-2">
                <div id="sticky-date-display" class="date-display">
                    Schedule
                </div>
                <button onclick="toggleFilterPane()" class="collapse-toggle" id="pane-toggle-btn">
                    <span id="pane-toggle-text">Filters</span>
                    <svg id="pane-arrow" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main id="event-list" class="max-w-2xl mx-auto px-4 pt-4"></main>

    <script src="events.js"></script>
    <script src="names.js"></script>

    <script>
        const FILTER_KEY = 'valentango_filter_pref';
        const THEME_KEY = 'valentango_theme_pref';
        const FAV_KEY = 'valentango_favorites';
        const PANE_KEY = 'valentango_pane_visible';
        const DAYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        
        let currentFilters = ['all'];
        let favorites = [];
        let dynamicInstructors = [];

        function initSettings() {
            try {
                const savedFilters = localStorage.getItem(FILTER_KEY);
                if (savedFilters) currentFilters = JSON.parse(savedFilters);
                const savedFavs = localStorage.getItem(FAV_KEY);
                if (savedFavs) favorites = JSON.parse(savedFavs);
                
                const isLight = localStorage.getItem(THEME_KEY) === 'true';
                if (isLight) {
                    document.body.classList.add('light-mode');
                    updateThemeButton(true);
                }

                const paneHidden = localStorage.getItem(PANE_KEY) === 'false';
                applyPaneState(!paneHidden);

                // Initialize dynamic instructor list from events
                if (typeof events !== 'undefined') {
                    const instructorSet = new Set();
                    events.forEach(e => {
                        if (e.type === 'class' && e.instructor && e.instructor !== "Various") {
                            instructorSet.add(e.instructor);
                        }
                    });
                    dynamicInstructors = Array.from(instructorSet).sort();
                    renderInstructorFilters();
                }

            } catch (e) { console.warn("Storage access denied", e); }
        }

        function renderInstructorFilters() {
            const container = document.getElementById('instructor-filters');
            if (!container) return;
            container.innerHTML = '';
            dynamicInstructors.forEach(ins => {
                const btn = document.createElement('button');
                btn.onclick = () => setFilter(ins);
                btn.id = `filter-${ins.replace(/\s+/g, '_')}`;
                btn.className = 'filter-chip';
                btn.innerText = ins;
                container.appendChild(btn);
            });
        }

        function toggleFilterPane() {
            const wrapper = document.getElementById('filter-wrapper');
            const isCurrentlyHidden = wrapper.classList.contains('collapsed');
            applyPaneState(isCurrentlyHidden);
            try { localStorage.setItem(PANE_KEY, isCurrentlyHidden); } catch (e) {}
        }

        function applyPaneState(isVisible) {
            const wrapper = document.getElementById('filter-wrapper');
            const btnText = document.getElementById('pane-toggle-text');
            const arrow = document.getElementById('pane-arrow');
            const searchInput = document.getElementById('search-input');
            
            if (isVisible) {
                wrapper.classList.remove('collapsed');
                btnText.innerText = "Hide Filters";
                arrow.classList.remove('collapsed-icon');
            } else {
                wrapper.classList.add('collapsed');
                let activeCount = currentFilters.filter(f => f !== 'all').length;
                if (searchInput && searchInput.value.trim().length > 0) activeCount++;
                btnText.innerText = activeCount > 0 ? `Show Filters ( ${activeCount} )` : "Show Filters";
                arrow.classList.add('collapsed-icon');
            }
            setTimeout(updateHeaderHeight, 350);
        }

        function updateHeaderHeight() {
            const header = document.querySelector('.main-header');
            if (header) {
                const height = header.offsetHeight;
                document.documentElement.style.setProperty('--header-height', height + 'px');
            }
        }

        function toggleFavorite(id) {
            const index = favorites.indexOf(id);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(id);
            try { localStorage.setItem(FAV_KEY, JSON.stringify(favorites)); } catch (e) {}
            renderEvents();
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            updateThemeButton(isLight);
            try { localStorage.setItem(THEME_KEY, isLight); } catch (e) {}
        }

        function updateThemeButton(isLight) {
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerText = isLight ? "Dark Mode" : "Light Mode";
        }

        function formatTime(iso) { 
            return new Date(iso).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).replace(' ', ''); 
        }
        function formatDate(iso) { return new Date(iso).toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' }); }

        function setFilter(filter) {
            if (filter === 'all') {
                currentFilters = ['all'];
            } else {
                currentFilters = currentFilters.filter(f => f !== 'all');
                if (currentFilters.includes(filter)) currentFilters = currentFilters.filter(f => f !== filter);
                else currentFilters.push(filter);
                if (currentFilters.length === 0) currentFilters = ['all'];
            }
            try { localStorage.setItem(FILTER_KEY, JSON.stringify(currentFilters)); } catch (e) {}
            
            const wrapper = document.getElementById('filter-wrapper');
            if (wrapper && wrapper.classList.contains('collapsed')) {
                applyPaneState(false);
            }

            updateFilterUI();
            renderEvents();
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            renderEvents();
            input.focus();
        }

        function clearFilters() { setFilter('all'); }

        function updateFilterUI() {
            // Standard filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                let filterId = chip.id.replace('filter-', '');
                // Handle instructor IDs that replaced spaces with underscores
                filterId = filterId.replace(/_/g, ' ');
                if (currentFilters.includes(filterId)) chip.classList.add('active');
                else chip.classList.remove('active');
            });

            const clearFiltersBtn = document.getElementById('clear-filters');
            if (currentFilters.length === 1 && currentFilters.includes('all')) clearFiltersBtn.classList.add('hidden');
            else clearFiltersBtn.classList.remove('hidden');
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            const wrapper = document.getElementById('filter-wrapper');
            if (wrapper && wrapper.classList.contains('collapsed')) applyPaneState(false);

            if (clearSearchBtn) searchTerm.length > 0 ? clearSearchBtn.classList.remove('hidden') : clearSearchBtn.classList.add('hidden');
            if (!list || typeof events === 'undefined') return;

            list.innerHTML = '';
            
            const linkifyInstructor = (instructorStr) => {
                if (!instructorStr || typeof nameToUrl === 'undefined') return instructorStr;
                let finalStr = instructorStr;
                const sortedNames = Object.keys(nameToUrl).sort((a, b) => b.length - a.length);
                sortedNames.forEach(name => {
                    if (finalStr.includes(name) && !finalStr.includes(`>${name}</a>`)) {
                        finalStr = finalStr.replace(name, `<a href="${nameToUrl[name]}" target="_blank">${name}</a>`);
                    }
                });
                return finalStr;
            };

            const filtered = events.filter(e => {
                if (currentFilters.includes('fav') && !favorites.includes(e.id)) return false;
                const matchesSearch = !searchTerm || e.title.toLowerCase().includes(searchTerm) || 
                    (e.instructor || "").toLowerCase().includes(searchTerm) || (e.description || "").toLowerCase().includes(searchTerm);
                if (!matchesSearch) return false;
                if (currentFilters.includes('all')) return true;

                const activeFilters = currentFilters.filter(f => f !== 'fav');
                if (activeFilters.length === 0) return true;

                const selectedDays = activeFilters.filter(f => DAYS.includes(f));
                const selectedInstructors = activeFilters.filter(f => dynamicInstructors.includes(f));
                const selectedCats = activeFilters.filter(f => !DAYS.includes(f) && !dynamicInstructors.includes(f));

                if (selectedDays.length > 0) {
                    const eventDay = new Date(e.start).toLocaleDateString([], { weekday: 'long' }).toLowerCase();
                    if (!selectedDays.includes(eventDay)) return false;
                }
                if (selectedInstructors.length > 0) {
                    if (!selectedInstructors.includes(e.instructor)) return false;
                }
                if (selectedCats.length > 0) {
                    const matchesCat = selectedCats.some(f => {
                        if (f === 'milonga') return e.type === 'milonga';
                        return (e.level || "").toLowerCase() === f.toLowerCase();
                    });
                    if (!matchesCat) return false;
                }
                return true;
            }).sort((a,b) => new Date(a.start) - new Date(b.start));

            updateFilterUI();

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-[var(--text-secondary)] opacity-50">No matches found.</div>`;
                return;
            }

            filtered.forEach(e => {
                const isFav = favorites.includes(e.id);
                const card = document.createElement('div');
                card.className = 'event-card';
                card.dataset.date = formatDate(e.start);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex flex-col gap-1">
                            <span class="text-[11px] font-black tracking-tight ${e.type === 'milonga' ? 'milonga-indicator' : 'class-indicator'}">${formatTime(e.start)}—${formatTime(e.end)}</span>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div onclick="toggleFavorite(${e.id})" class="fav-star ${isFav ? 'text-amber-400' : 'text-zinc-600 opacity-30'}">★</div>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-x-2 gap-y-1 mb-2">
                        <span class="text-[10px] font-bold uppercase tracking-wider opacity-70" style="color: var(--text-secondary)">${e.level === 'advCouples' ? 'ADV COUPLES' : e.level}</span>
                        <span class="text-[10px] opacity-30">|</span>
                        <span class="room-pill">${e.room}</span>
                        <span class="text-[10px] opacity-30">|</span>
                        <span class="price-text">${e.price}</span>
                        <span class="text-[10px] opacity-30">|</span>
                        <span class="text-[10px] font-bold uppercase tracking-wider instructor-link" style="color: var(--accent-purple)">${linkifyInstructor(e.instructor)}</span>
                    </div>
                    <h3 class="text-lg sm:text-xl font-bold leading-tight mb-1" style="color: var(--text-primary)">${e.title}</h3>
                    <p class="text-[13px] leading-snug font-normal opacity-90" style="color: var(--text-secondary)">${e.description}</p>
                `;
                list.appendChild(card);
            });
            updateDateOnScroll();
        }

        function updateDateOnScroll() {
            const cards = document.querySelectorAll('.event-card');
            const dateDisplay = document.getElementById('sticky-date-display');
            const headerHeight = document.querySelector('.main-header').offsetHeight;
            
            let currentVisibleDate = "";
            for (let card of cards) {
                const rect = card.getBoundingClientRect();
                if (rect.top <= headerHeight + 100) {
                    currentVisibleDate = card.dataset.date;
                } else {
                    break;
                }
            }
            if (currentVisibleDate) dateDisplay.innerText = currentVisibleDate;
        }

        window.addEventListener('scroll', updateDateOnScroll);
        window.addEventListener('load', () => {
            initSettings();
            updateFilterUI();
            renderEvents();
            updateHeaderHeight();
        });
        window.addEventListener('resize', updateHeaderHeight);
    </script>

    <footer class="fixed bottom-0 left-0 right-0 z-50 px-4 pb-6 pt-2 pointer-events-none">
        <div class="max-w-2xl mx-auto flex justify-center gap-3 pointer-events-auto">
            <a href="how.html" class="footer-link"><span>?</span></a>
            <a href="https://valentango.us/parking/" target="_blank" class="footer-link"><span>Parking</span></a>
            <a href="map.html" class="footer-link"><span>Venue Map</span></a>
        </div>
    </footer>
</body>
</html>