<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ValenTango 2026 Full Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="transition-colors">

    <header class="main-header sticky top-0 z-40">
        <div class="max-w-2xl mx-auto px-6 pb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight">ValenTango Schedule</h1>
                    <p class="text-xs uppercase tracking-widest font-bold mt-1" style="color: var(--text-secondary)">Portland 2026</p>
                </div>
                <button onclick="toggleTheme()" class="theme-toggle" id="theme-btn">Light Mode</button>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">                <button onclick="setFilter('all')" id="filter-all" class="filter-chip active">All</button>
                <button onclick="setFilter('milonga')" id="filter-milonga" class="filter-chip">Milongas</button>
                <button onclick="setFilter('beg')" id="filter-beg" class="filter-chip">Beg</button>
                <button onclick="setFilter('int')" id="filter-int" class="filter-chip">Int</button>
                <button onclick="setFilter('adv')" id="filter-adv" class="filter-chip">Adv</button>
                <button onclick="setFilter('advCouples')" id="filter-advCouples" class="filter-chip">Adv Couples</button>
                
                <button onclick="clearFilters()" id="clear-filters" class="text-[11px] font-black uppercase tracking-widest px-2 text-rose-500 hidden whitespace-nowrap bg-transparent border-none cursor-pointer">
                    Clear ×
                </button>
            </div>
        </div>
    </header>

    <main id="event-list" class="max-w-2xl mx-auto px-6 pt-4"></main>

    <script src="events.js"></script>
    <script>
        const FILTER_KEY = 'valentango_filter_pref';
        const THEME_KEY = 'valentango_theme_pref';
        
        // State now uses an array to track multiple active filters
        let currentFilters = ['all'];

        function initSettings() {
            try {
                // Filter Init: Parse JSON array from storage
                const savedFilters = localStorage.getItem(FILTER_KEY);
                if (savedFilters) {
                    currentFilters = JSON.parse(savedFilters);
                }

                // Theme Init
                const isLight = localStorage.getItem(THEME_KEY) === 'true';
                if (isLight) {
                    document.body.classList.add('light-mode');
                    updateThemeButton(true);
                }
            } catch (e) { console.warn("Storage access denied", e); }
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            updateThemeButton(isLight);
            try {
                localStorage.setItem(THEME_KEY, isLight);
            } catch (e) { console.warn("Could not save theme", e); }
        }

        function updateThemeButton(isLight) {
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerText = isLight ? "Dark Mode" : "Light Mode";
        }

        function formatTime(iso) { return new Date(iso).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); }
        function formatDate(iso) { return new Date(iso).toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' }); }

        function setFilter(filter) {
            if (filter === 'all') {
                currentFilters = ['all'];
            } else {
                // If we select a category, remove the 'all' state
                currentFilters = currentFilters.filter(f => f !== 'all');

                if (currentFilters.includes(filter)) {
                    // Toggle off if already selected
                    currentFilters = currentFilters.filter(f => f !== filter);
                } else {
                    // Add to active filters
                    currentFilters.push(filter);
                }

                // Default back to 'all' if list becomes empty
                if (currentFilters.length === 0) currentFilters = ['all'];
            }

            try { 
                localStorage.setItem(FILTER_KEY, JSON.stringify(currentFilters)); 
            } catch (e) {}
            
            updateFilterUI();
            renderEvents();
        }

        function clearFilters() {
            setFilter('all');
        }

        function updateFilterUI() {
            // Update Chip active states
            document.querySelectorAll('.filter-chip').forEach(chip => {
                const filterId = chip.id.replace('filter-', '');
                if (currentFilters.includes(filterId)) {
                    chip.classList.add('active');
                } else {
                    chip.classList.remove('active');
                }
            });

            // Toggle visibility of the Clear button
            const clearBtn = document.getElementById('clear-filters');
            if (currentFilters.includes('all')) {
                clearBtn.classList.add('hidden');
            } else {
                clearBtn.classList.remove('hidden');
            }
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            if (!list || typeof events === 'undefined') return;

            list.innerHTML = '';
            
            const filtered = events.filter(e => {
                // If 'all' is active, show everything
                if (currentFilters.includes('all')) return true;
                
                // Show event if it matches ANY of the selected filters
                return currentFilters.some(f => {
                    if (f === 'milonga') return e.type === 'milonga';
                    return (e.level || "").toLowerCase() === f.toLowerCase();
                });
            }).sort((a,b) => new Date(a.start) - new Date(b.start));

            let lastDate = '';
            filtered.forEach(e => {
                const dateStr = formatDate(e.start);
                if(dateStr !== lastDate) {
                    const h = document.createElement('div');
                    h.className = 'date-divider';
                    h.innerText = dateStr;
                    list.appendChild(h);
                    lastDate = dateStr;
                }

                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-black tracking-tighter ${e.type === 'milonga' ? 'milonga-indicator' : 'class-indicator'}">${formatTime(e.start)} - ${formatTime(e.end)}</span>
                            <span class="room-pill">${e.room}</span>
                        </div>
                        <span class="price-text">${e.price}</span>
                    </div>
                    <h3 class="text-xl font-bold leading-tight mb-2" style="color: var(--text-primary)">${e.title}</h3>
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-[11px] font-bold uppercase tracking-wider" style="color: var(--text-secondary)">${e.level === 'advCouples' ? 'ADV COUPLES' : e.level}</span>
                        <span style="color: var(--border-color)">•</span>
                        <span class="text-[11px] font-bold uppercase tracking-wider" style="color: var(--accent-purple)">${e.instructor}</span>
                    </div>
                    <p class="text-[14px] leading-relaxed font-normal" style="color: var(--text-secondary)">${e.description}</p>
                `;
                list.appendChild(card);
            });
        }

        window.addEventListener('load', () => {
            initSettings();
            updateFilterUI();
            renderEvents();
        });
    </script>
    HTML
    <footer class="fixed bottom-0 left-0 right-0 z-50 px-6 pb-8 pt-4 pointer-events-none">
        <div class="max-w-2xl mx-auto flex justify-center gap-4 pointer-events-auto">
            <a href="https://valentango.us/parking/" target="_blank" class="footer-link">
                <span>Parking</span>
            </a>
            <a href="map.html" class="footer-link">
                <span>Venue Map</span>
            </a>
        </div>
    </footer>
</body>
</html>